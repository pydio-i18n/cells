#------------------------------------------
# Actual Bootstrap Keys
#
# Defaults variable values are injected at load time
#------------------------------------------
name: datasources
processes:
  datasource-peer:
    connections: *connections
    {{{{- $ := . }}}}
    processes:
      {{{{- range $k,$v := .ObjectsSources}}}}
      objects-{{{{$k}}}}:
        runtime: datasource-objects
        connections: *connections
        listeners:
          grpc{{{{$k}}}}:
            type: tcp
            bind: 0.0.0.0
            port: 0
        servers:
          grpc{{{{$k}}}}:
            type: grpc
            listener: grpc{{{{$k}}}}
            services:
              - filter: "{{ .Name }} ~= pydio.grpc.data.objects.{{{{$v.Name}}}}"
        env:
          <<: *env
          DATASOURCE: "{{{{$v.Name}}}}"
        queues: *queues
        caches: *caches
      {{{{- end}}}}
      {{{{- range $k,$v := .DataSources}}}}
      index-{{{{$k}}}}:
        runtime: datasource-index
        connections: *connections
        listeners:
          grpc{{{{$k}}}}:
            type: tcp
            bind: 0.0.0.0
            port: 0
        servers:
          grpc{{{{$k}}}}:
            type: grpc
            listener: grpc{{{{$k}}}}
            services:
              - filter: "{{ .Name }} ~= pydio.grpc.data.index.{{{{$v.Name}}}} or {{ .Name }} ~= pydio.grpc.data.sync.{{{{$v.Name}}}}"
        env:
          <<: *env
          DATASOURCE: "{{{{$v.Name}}}}"
        storages: *storages
        services:
          pydio.grpc.data.index.{{{{$v.Name}}}}:
            storages:
              main:
                - type: sql
                  prefix: data_index_{{{{$v.Name}}}}_
        queues: *queues
        caches: *caches
      {{{{- end}}}}
env: *env