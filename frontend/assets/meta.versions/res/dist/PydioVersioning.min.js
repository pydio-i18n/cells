(()=>{"use strict";var e={81:e=>{e.exports=require("pydio/http/api")},492:e=>{e.exports=require("pydio/model/node")}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};r.r(n),r.d(n,{Callbacks:()=>L,HistoryDialog:()=>D,InfoPanel:()=>Z});const o=require("pydio");var i=r.n(o);const a=require("react");var l=r.n(a);const s=require("create-react-class");var c=r.n(s);const u=require("pydio/model/meta-node-provider");var p=r.n(u);const f=require("react-markdown");var d=r.n(f);const y=require("pydio/util/path");var m=r.n(y);const v=require("lodash.debounce");var b=r.n(v);function g(e){return g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g(e)}var h=["node"],w=["node"];function O(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,P(n.key),n)}}function P(e){var t=function(e){if("object"!=g(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=g(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==g(t)?t:t+""}function j(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(j=function(){return!!e})()}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}function _(e,t){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_(e,t)}function x(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(t.includes(n))continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.includes(r)||{}.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var k=r(81),E=r(492),M=i().requireLib("components"),C=M.Timeline,I=M.UserAvatar,q=i().requireLib("boot").moment,T={a:function(e){return e.node,function(e){var t=e.href,r=e.children;if(t.startsWith("user://")){var n=t.replace("user://","");return l().createElement(I,{userId:n,displayAvatar:!1,richOnClick:!1,style:{display:"inline-block",fontWeight:500},pydio:i().getInstance()})}return l().createElement("span",null,r)}(x(e,h))},p:function(e){var t;return e.node,t=x(e,w).children,l().createElement("span",null,t)}};const A=function(e){function t(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=function(e,t,r){return t=S(t),function(e,t){if(t&&("object"==g(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,j()?Reflect.construct(t,r||[],S(e).constructor):t.apply(e,r))}(this,t,[e])).state={loading:!0,revs:[],selection:e.preselection},r._bload=b()(r.load.bind(r),1500),r.load(),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_(e,t)}(t,e),r=t,(n=[{key:"componentDidUpdate",value:function(e,t,r){e.node!==this.props.node&&(e.node&&e.node.stopObserving("node_replaced",this._bload),this.props.node&&this.props.node.observe("node_replaced",this._bload),this.load())}},{key:"getMessage",value:function(e){return i().getMessages()["meta.versions."+e]||e}},{key:"load",value:function(){var e=this,t=this.props.node,r={versions:"true",file:t.getPath(),silent:!0};t.getMetadata().has("repository_id")&&(r.tmp_repository_id=t.getMetadata().get("repository_id"));var n=new(p())(r),o=new E("/",!1,"Versions","folder.png",n);this.setState({empty:!1}),n.loadNode(o,(function(t){var r=[];t.getChildren().forEach((function(e){return r.push(e)})),e.setState({loading:!1,revs:r,empty:!r.length})}))}},{key:"applyAction",value:function(e,t){var r=this.props,n=r.node,o=r.onRequestClose;switch(e){case"dl":k.getClient().openVersion(n,t.getMetadata().get("versionId"));break;case"revert":if(!confirm(this.getMessage("13")))return;k.getClient().revertToVersion(n,t.getMetadata().get("versionId"),(function(){o&&o()}))}}},{key:"itemActions",value:function(e,t,r){var n=this;return t?[{onClick:function(){return n.applyAction("dl",e)},label:this.getMessage("3")},{onClick:function(){return n.applyAction("revert",e)},label:this.getMessage("7")}]:[]}},{key:"itemAnnotations",value:function(e,t,r){var n,o=parseInt(e.getMetadata().get("bytesize"));if(r){var i=parseInt(r.getMetadata().get("bytesize"));n=i===o?"right":i>o?"bottom-right":"top-right"}return l().createElement("div",{className:"tl-annotation"},n&&l().createElement("span",{className:"tl-annotation-dir mdi mdi-arrow-"+n}),m().roundFileSize(o))}},{key:"render",value:function(){var e=this.state,t=e.loading,r=e.revs,n=e.selection,o=e.empty;if(t)return l().createElement("div",{style:{textAlign:"center",fontWeight:500,opacity:.3,padding:20}},i().getMessages()[466]);if(o)return l().createElement("div",{style:{textAlign:"center",fontWeight:500,opacity:.3,padding:20,paddingBottom:30}},this.getMessage("14"));var a=this.props,s=a.className,c=void 0===s?"":s,u=a.onClick;return l().createElement(C,{items:r,className:c,useSelection:!0,preSelection:n,onItemSelect:u,itemUuid:function(e){return e.getMetadata().get("versionId")},itemMoment:function(e){return q(1e3*e.getMetadata().get("ajxp_modiftime"))},itemDesc:function(e){return l().createElement(d(),{urlTransform:function(e){return e},components:T},e.getMetadata().get("versionDescription"))},itemActions:this.itemActions.bind(this),itemAnnotations:this.itemAnnotations.bind(this),itemClassName:function(e){return r&&0===r.indexOf(e)?"current-revision":""},color:"#2196f3"})}}])&&O(r.prototype,n),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,n}(a.Component);var N=i().requireLib("boot"),D=c()({displayName:"HistoryDialog",mixins:[N.ActionDialogMixin,N.SubmitButtonProviderMixin],getDefaultProps:function(){return{dialogTitle:i().getMessages()["meta.versions.2"],dialogIsModal:!1,dialogSize:"lg",dialogPadding:!1}},submit:function(){this.dismiss()},render:function(){var e,t=this.props,r=t.node,n=t.args;return n&&n.length>0&&(e=n[0]),l().createElement("div",{style:{width:"100%"},className:"layout-fill vertical-layout"},l().createElement("div",{style:{display:"flex",flexDirection:"column",color:"rgba(0,0,0,.87)"},className:"version-history"},l().createElement(A,{className:"meta-revisions",node:r,preselection:e,onRequestClose:this.dismiss.bind(this)})))}});function R(e){return R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},R(e)}function B(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,H(n.key),n)}}function H(e){var t=function(e){if("object"!=R(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=R(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==R(t)?t:t+""}var L=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)},t=[{key:"loadHistoryBrowser",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];pydio.UI.openComponentInModal("PydioVersioning","HistoryDialog",{node:i().getInstance().getContextHolder().getUniqueNode(),args:t})}}],null&&B(e.prototype,null),t&&B(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function U(e){return U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},U(e)}var V=["node"];function z(){return z=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)({}).hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},z.apply(null,arguments)}function W(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,F(n.key),n)}}function F(e){var t=function(e){if("object"!=U(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=U(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==U(t)?t:t+""}function G(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(G=function(){return!!e})()}function J(e){return J=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},J(e)}function K(e,t){return K=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},K(e,t)}var Q=i().requireLib("boot").PydioContextConsumer,X=i().requireLib("workspaces").InfoPanelCard,Y=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t,r){return t=J(t),function(e,t){if(t&&("object"==U(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,G()?Reflect.construct(t,r||[],J(e).constructor):t.apply(e,r))}(this,t,arguments)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&K(e,t)}(t,e),r=t,n=[{key:"render",value:function(){var e=this.props,t=e.node,r=function(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(t.includes(n))continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.includes(r)||{}.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}(e,V);return t&&t.getMetadata().has("datasource_versioning")?l().createElement(X,z({},r,{identifier:"meta-versions",icon:"mdi mdi-history",style:this.props.style,title:i().getMessages()["meta.versions.1"]}),l().createElement(A,{node:t,className:"meta-revisions small",onClick:function(e){return i().getInstance().Controller.fireAction("versions_history",e)}}),l().createElement("style",{type:"text/css",dangerouslySetInnerHTML:{__html:"\n        .timeline.small.meta-revisions .tl-timeline .tl-block .tl-card .tl-actions {\n            display: flex;\n        }\n        .timeline.meta-revisions .tl-timeline .tl-block.current-revision .tl-card{\n            position:relative;\n            box-shadow: none !important;\n        }\n        .timeline.meta-revisions.small .tl-timeline .tl-block.current-revision .tl-card{\n            background-color: var(--md-sys-color-tertiary-container);\n        }\n        .timeline.meta-revisions .tl-timeline .tl-block.current-revision .tl-card:before {\n            content: '';\n            border: 1px solid var(--md-sys-color-tertiary);\n            position: absolute;\n            top: -6px;\n            bottom: -6px;\n            right: -6px;\n            left: -6px;\n            border-radius: 6px;\n        }        \n        .timeline.meta-revisions.small .tl-timeline .tl-block.current-revision .tl-card:before {\n            border: 1px solid var(--md-sys-color-tertiary-container);\n        }\n        .timeline .tl-timeline .tl-block .tl-card .tl-actions a {\n            color: var(--md-sys-color-primary);\n            border: 1px solid var(--md-sys-color-primary);\n            padding: 0 12px;\n            border-radius: 20px; \n            cursor: pointer;\n       }\n        .timeline .tl-timeline .tl-block .tl-card .tl-actions a:hover {\n            background-color: var(--md-sys-color-primary);\n            border: 1px solid var(--md-sys-color-primary);\n            color:var(--md-sys-color-on-primary) !important;\n       }\n        "}})):null}}],n&&W(r.prototype,n),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,n}(a.Component);const Z=Y=Q(Y);window.PydioVersioning=n})();