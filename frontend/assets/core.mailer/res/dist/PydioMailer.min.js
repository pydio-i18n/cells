(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Pane:()=>D,PreferencesPanel:()=>C});const r=require("react");var s=e.n(r);const n=require("pydio");var o=e.n(n);const i=require("prop-types");var a=e.n(i);const l=require("pydio/http/api");var u=e.n(l);const p=require("material-ui"),c=require("material-ui/styles"),d=require("cells-sdk");function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){f(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function f(e,t,r){return(t=j(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,j(s.key),s)}}function v(e,t,r){return t&&b(e.prototype,t),r&&b(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function j(e){var t=function(e,t){if("object"!==h(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,"string");if("object"!==h(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===h(t)?t:String(t)}function O(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},k(e,t)}function S(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,s=w(e);if(t){var n=w(this).constructor;r=Reflect.construct(s,arguments,n)}else r=s.apply(this,arguments);return function(e,t){if(t&&("object"===h(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r)}}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}var E=o().requireLib("components").UsersCompleter,P={chip:{marginRight:4,marginBottom:4},wrapper:{display:"flex",flexWrap:"wrap"},overlay:{position:"absolute",top:0,right:0,left:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.33)",paddingTop:77,zIndex:100}},_=function(e){O(r,e);var t=S(r);function r(){return y(this,r),t.apply(this,arguments)}return v(r,[{key:"render",value:function(){var e=this.props.user;return s().createElement("div",{className:"share-dialog user-badge user-type-"+(e.getTemporary()?"tmp_user":"user")},s().createElement("span",{className:"avatar icon-"+(e.getTemporary()?"envelope":"user")}),s().createElement("span",{className:"user-badge-label"},e.getExtendedLabel()||e.getLabel()))}}]),r}(s().Component),T=function(e){O(r,e);var t=S(r);function r(){return y(this,r),t.apply(this,arguments)}return v(r,[{key:"render",value:function(){var e,t=this.props,r=t.user,n=t.onRemove,o=t.muiTheme,i=r.FreeValue;e=i?r.FreeValue:r.Attributes&&r.Attributes.displayName?r.Attributes.displayName:r.Login;var a={def:{background:c.colors.blueGrey100,avatarBg:c.colors.blueGrey300,avatarColor:c.colors.blueGrey600},tmp:{background:c.colors.lightBlue100,avatarBg:c.colors.lightBlue300,avatarColor:"white"}};if("mui3"===o.userTheme){var l=o.palette.mui3;a={def:{background:l["primary-container"],avatarBg:l["inverse-primary"],avatarColor:l.primary},tmp:{background:l["secondary-container"],avatarBg:l["on-secondary-container"],avatarColor:l["on-secondary"]}}}var u=s().createElement(p.FontIcon,{className:"mdi mdi-"+(i?"email":"account")});return s().createElement(p.Chip,{backgroundColor:a[i?"tmp":"def"].background,onRequestDelete:function(){n()},style:P.chip},s().createElement(p.Avatar,{icon:u,color:a[i?"tmp":"def"].avatarColor,backgroundColor:a[i?"tmp":"def"].avatarBg}),e)}}]),r}(s().Component);T=(0,c.muiThemeable)()(T);var M=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;y(this,e),this._subjects=[],this._messages=[],this._targets=[],this._links=[],this.templateId="",this.templateData={},t&&this._subjects.push(t),r&&this._messages.push(r),s&&this._links.push(s)}return v(e,[{key:"addTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._targets.push(e),t&&this._subjects.push(t),r&&this._messages.push(r),s&&this._links.push(s)}},{key:"setTemplateData",value:function(e,t){this.templateId=e,this.templateData=t}},{key:"postOne",value:function(e,t,r,s){var n=new d.MailerServiceApi(u().getRestClient()),o=new d.MailerMail;return o.Subject=t,o.To=e.map((function(e){return d.MailerUser.constructFromObject({Uuid:e})})),o.TemplateId=r,o.TemplateData=s,n.send(o)}},{key:"post",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._subjects.length&&!this.templateId||!this._targets.length||!this._messages.length)throw new Error("Invalid data");var r=g({},this.templateData),s=[];if(this._messages.length>1&&this._messages.length===this._targets.length&&this._subjects.length===this._targets.length)this._targets.map((function(t,n){var o=e._subjects[n];r=g(g({},r),{},{Message:e._messages[n]}),s.push(e.postOne([t],o,e.templateId,r))}));else{var n=this._subjects[0];r.Message=this._messages[0],s.push(this.postOne(this._targets,n,this.templateId,r))}Promise.all(s).then((function(){t(!0)})).catch((function(e){e.response&&e.response.body&&e.response.body.Title&&(e=new Error(e.response.body.Title)),t(!1,e)}))}}]),e}(),D=function(e){O(r,e);var t=S(r);function r(e){var s;return y(this,r),void 0===e.showAddressBook&&(e.showAddressBook=!0),(s=t.call(this,e)).state={users:s.props.users||{},subject:s.props.subject,message:s.props.message,errorMessage:null,posting:!1},s}return v(r,[{key:"updateSubject",value:function(e){this.setState({subject:e.currentTarget.value})}},{key:"updateMessage",value:function(e){this.setState({message:e.currentTarget.value})}},{key:"addUser",value:function(e){var t=this.state.users;e.FreeValue?t[e.FreeValue]=e:e.IdmUser&&(t[e.IdmUser.Login]=e.IdmUser),this.setState({users:t,errorMessage:null})}},{key:"removeUser",value:function(e){var t=this.state.users;delete t[e],this.setState({users:t})}},{key:"getMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;try{return void 0===t&&(t="core.mailer"),t&&(t+="."),pydio.MessageHash[t+e]}catch(t){return e}}},{key:"postEmail",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=this.state,s=r.users,n=r.subject,o=r.message;if(!t&&this.refs.completer&&this.refs.completer.getPendingSearchText&&this.refs.completer.getPendingSearchText())return this.refs.completer.onCompleterRequest(this.refs.completer.getPendingSearchText(),-1),void setTimeout((function(){return e.postEmail(!0)}),500);if(Object.keys(s).length){var i=this.props,a=i.link,l=i.templateId,u=i.templateData,p=function(t,r){e.setState({posting:!1}),t?(e.props.pydio.UI.displayMessage("SUCCESS",e.props.pydio.MessageHash["core.mailer.1"].replace("%s",Object.keys(s).length)),e.props.onDismiss?e.props.onDismiss():e.setState({users:{},subject:"",message:""})):e.props.pydio.UI.displayMessage("ERROR",e.props.pydio.MessageHash["core.mailer.sender.error"]+(r?" : "+r.message:""))};if(this.setState({posting:!0}),this.props.processPost)this.props.processPost(M,s,n,o,a,p);else{var c=new M(n,o,a||null);Object.keys(s).forEach((function(e){c.addTarget(e)})),l&&c.setTemplateData(l,u),c.post(p)}}else this.setState({errorMessage:this.getMessage(2)})}},{key:"render",value:function(){var e,t=this,r=this.state,n=r.users,o=r.posting,i=r.errorMessage,a=r.subject,l=r.message,u=[this.props.className,"react-mailer","reset-pydio-forms"].join(" "),c=Object.keys(n).map(function(e){var t=this;return s().createElement(T,{key:e,user:n[e],onRemove:function(){t.removeUser(e)}})}.bind(this));i&&(e=s().createElement("div",{style:{padding:"10px 20px",color:"red"}},i));var d=g({margin:this.props.uniqueUserStyle?0:8},this.props.style),h=s().createElement(p.Paper,{zDepth:void 0!==this.props.zDepth?this.props.zDepth:2,className:u,style:d},s().createElement("h3",{style:g({padding:20,fontSize:25,marginBottom:0,paddingBottom:10},this.props.titleStyle)},this.props.panelTitle),e,this.props.additionalPaneTop,!this.props.uniqueUserStyle&&s().createElement("div",{className:"users-block",style:g({padding:"0 20px"},this.props.usersBlockStyle)},s().createElement(E,{ref:"completer",fieldLabel:this.getMessage("8"),usersOnly:!0,existingOnly:!0,freeValueAllowed:!0,onValueSelected:this.addUser.bind(this),excludes:Object.keys(n),renderSuggestion:function(e){return s().createElement(_,{user:e})},pydio,showAddressBook:this.props.showAddressBook,underlineHide:!0}),s().createElement("div",{style:P.wrapper},c)),!this.props.uniqueUserStyle&&s().createElement(p.Divider,null),!this.props.templateId&&s().createElement("div",{style:{padding:"0 20px"}},s().createElement(p.TextField,{fullWidth:!0,underlineShow:!1,floatingLabelText:this.getMessage("6"),value:a,onChange:this.updateSubject.bind(this)})),!this.props.templateId&&s().createElement(p.Divider,null),s().createElement("div",{style:g({padding:"0 20px"},this.props.messageBlockStyle)},s().createElement(p.TextField,{fullWidth:!0,underlineShow:!1,floatingLabelText:this.getMessage("7"),value:l,multiLine:!0,onChange:this.updateMessage.bind(this),rowsMax:6})),this.props.additionalPaneBottom,s().createElement(p.Divider,null),s().createElement("div",{style:{textAlign:"right",padding:"8px 20px"}},this.props.onDismiss&&s().createElement(p.FlatButton,{label:this.getMessage("54",""),onClick:this.props.onDismiss}),!this.props.onDismiss&&s().createElement(p.FlatButton,{label:this.getMessage("216",""),onClick:function(){t.setState({users:{},subject:"",message:""})}}),s().createElement(p.FlatButton,{disabled:o,primary:!0,label:this.getMessage("77",""),onClick:function(e){return t.postEmail()}})));return this.props.overlay?s().createElement("div",{style:P.overlay},h):h}}]),r}(s().Component);D.PropTypes={message:a().string,subject:a().string,templateId:a().string,templateData:a().object,link:a().string,onDismiss:a().func,className:a().string,overlay:a().bool,uniqueUserStyle:a().bool,users:a().object,panelTitle:a().string,zDepth:a().number,showAddressBook:a().bool,processPost:a().func,additionalPaneTop:a().instanceOf(s().Component),additionalPaneBottom:a().instanceOf(s().Component)};var C=function(e){O(r,e);var t=S(r);function r(){return y(this,r),t.apply(this,arguments)}return v(r,[{key:"render",value:function(){return s().createElement("div",null,"Preferences Panel")}}]),r}(s().Component);window.PydioMailer=t})();